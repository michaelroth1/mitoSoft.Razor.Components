@using mitoSoft.Razor.Components.Enums

@inherits Microsoft.AspNetCore.Components.Web.ErrorBoundary

@inject IJSRuntime JsRuntime

@* https://github.com/dotnet/aspnetcore/blob/9ace45d8dffb0c89026df3cd989b49f87c61344c/src/Components/test/testassets/BasicTestApp/ErrorBoundaryTest/CustomErrorBoundary.razor *@

@if (!string.IsNullOrEmpty(this.Message) && ErrorContent is null && Mode == ErrorBoundaryMode.ErrorText)
{
    <div class="mitosoft-error-boundary">
        <div class="row">
            <label class="form-label text-danger mitosoft-text-danger">
                @this.Message
            </label>
        </div>
        <div class="row">
            <div class="col-auto">
                <button class="btn btn-danger mitosoft-btn mitosoft-btn-danger" @onclick="OkClicked">
                    Ok
                </button>
            </div>
        </div>
    </div>

    @ChildContent
}
else if (ErrorContent is not null)
{
    @ErrorContent(CurrentException!)
}
else
{
    @ChildContent
}

@code {
    List<Exception> receivedExceptions = new();

    [Parameter]
    public Action<Exception> OnExceptionFired { get; set; }

    [Parameter]
    public string Message { get; set; } = "";

    [Parameter]
    public ErrorBoundaryMode Mode { get; set; } = ErrorBoundaryMode.JSModal;

    protected override Task OnErrorAsync(Exception exception)
    {
        this.Message = exception.Message;
        receivedExceptions.Add(exception);

        this.OnExceptionFired?.Invoke(exception);

        if (Mode == ErrorBoundaryMode.JSModal)
        {
            this.ShowExceptionMessage(this.Message);

            this.Message = "";
        }

        return base.OnErrorAsync(exception);
    }

    private void OkClicked()
    {
        this.Message = "";
        InvokeAsync(StateHasChanged);
    }

    public new void Recover()
    {
        this.Message = "";
        receivedExceptions.Clear();
        base.Recover();
    }

    private void ShowExceptionMessage(string message)
    {
        JsRuntime.InvokeVoidAsync("alert", message);
    }

    protected override void OnParametersSet() //website state bleibt erhalten
    {
        this?.Recover();
    }
}